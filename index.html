<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Pygram IDE v9</title>
<style>
/* ‚îÄ‚îÄ System fonts only ‚Äî zero CDN ‚îÄ‚îÄ */
:root{
  --bg:#0d0f14;--sb:#13161e;--panel:#181c26;--border:#252a38;
  --acc:#00d4aa;--red:#f38ba8;--green:#a6e3a1;--blue:#89b4fa;
  --pur:#cba6f7;--yel:#f9e2af;--text:#cdd6f4;--dim:#6c7394;
  --ed:#282c34;--mono:ui-monospace,'Cascadia Code','Fira Code',monospace;
  --sans:system-ui,-apple-system,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--sans);background:var(--bg);color:var(--text);
  height:100vh;display:flex;flex-direction:column;overflow:hidden;font-size:14px}

/* TITLEBAR */
#tb{height:44px;background:var(--sb);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 12px;gap:10px;flex-shrink:0}
.logo{font-weight:700;font-size:1rem;color:#fff;display:flex;align-items:center;gap:6px}
.logo b{color:var(--acc)}
.filetab{display:flex;align-items:center;gap:5px;background:var(--panel);
  border:1px solid var(--border);border-bottom:none;padding:4px 10px;
  border-radius:5px 5px 0 0;font-family:var(--mono);font-size:12px;
  color:var(--text);position:relative;bottom:-1px}
.dot{width:7px;height:7px;border-radius:50%;background:var(--yel)}
.ltog{display:flex;background:var(--bg);border:1px solid var(--border);
  border-radius:20px;padding:2px;gap:2px;margin-left:auto}
.lbtn{padding:3px 10px;border-radius:16px;font-size:12px;font-weight:600;
  cursor:pointer;border:none;background:transparent;color:var(--dim);transition:all .15s}
.lbtn.on{background:var(--acc);color:#000}

/* WORKSPACE */
#ws{flex:1;display:flex;overflow:hidden}

/* SIDEBAR */
#side{width:44px;background:var(--sb);border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;padding:5px 0;gap:2px;flex-shrink:0}
.sbtn{width:34px;height:34px;border-radius:6px;display:flex;align-items:center;
  justify-content:center;cursor:pointer;border:none;background:transparent;
  color:var(--dim);font-size:15px;transition:all .15s;position:relative}
.sbtn:hover,.sbtn.on{background:var(--panel);color:var(--acc)}
.sbtn:hover::after{content:attr(title);position:absolute;left:40px;background:var(--panel);
  border:1px solid var(--border);color:var(--text);padding:3px 8px;border-radius:4px;
  font-size:11px;white-space:nowrap;z-index:999;pointer-events:none}

/* FILE EXPLORER */
#fe{width:200px;background:var(--sb);border-right:1px solid var(--border);
  display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;transition:width .18s}
#fe.hide{width:0}
#fe-hdr{height:32px;display:flex;align-items:center;justify-content:space-between;
  padding:0 8px 0 12px;font-size:11px;font-weight:700;color:var(--dim);
  letter-spacing:.08em;text-transform:uppercase;border-bottom:1px solid var(--border);flex-shrink:0}
.fe-hbtn{width:20px;height:20px;border-radius:3px;background:transparent;border:none;
  color:var(--dim);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fe-hbtn:hover{background:var(--border);color:var(--text)}
#fe-root{display:flex;align-items:center;gap:5px;padding:5px 8px;font-size:12px;
  font-weight:600;color:var(--text);cursor:pointer;user-select:none}
#fe-root:hover{background:rgba(255,255,255,.03)}
#fe-arr{font-size:9px;transition:transform .15s}
#fe-arr.o{transform:rotate(90deg)}
#fe-list{flex:1;overflow-y:auto;padding:1px 0}
#fe-list::-webkit-scrollbar{width:3px}
#fe-list::-webkit-scrollbar-thumb{background:var(--border)}
.fitem{display:flex;align-items:center;gap:5px;padding:4px 8px 4px 18px;
  font-size:12px;font-family:var(--mono);color:var(--dim);cursor:pointer;
  user-select:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  transition:background .1s;position:relative}
.fitem:hover{background:rgba(255,255,255,.05);color:var(--text)}
.fitem.on{background:rgba(0,212,170,.1);color:var(--acc)}
.fitem.on::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--acc)}
.fri{background:transparent;border:1px solid var(--acc);border-radius:3px;
  color:var(--text);font-family:var(--mono);font-size:12px;padding:1px 4px;outline:none;flex:1}

/* CTX */
#ctx{position:fixed;background:var(--panel);border:1px solid var(--border);border-radius:6px;
  padding:3px 0;min-width:140px;z-index:9999;box-shadow:0 8px 28px rgba(0,0,0,.5);
  display:none;font-size:12px}
.ci{padding:6px 12px;cursor:pointer;color:var(--text);display:flex;align-items:center;gap:6px}
.ci:hover{background:rgba(255,255,255,.07)}
.ci.d{color:var(--red)}
.ci.d:hover{background:rgba(243,139,168,.1)}
.cs{height:1px;background:var(--border);margin:3px 0}

/* EDITOR AREA */
#ea{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#toolbar{height:38px;background:var(--panel);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 8px;gap:6px;flex-shrink:0}
.rbtn{display:flex;align-items:center;gap:5px;background:var(--acc);color:#000;
  border:none;border-radius:5px;padding:5px 13px;font-weight:700;font-size:13px;
  cursor:pointer;transition:all .15s;font-family:var(--sans)}
.rbtn:hover{background:#00efb8;transform:scale(1.03)}
.rbtn.run{background:var(--red);color:#fff}
.tbtn{display:flex;align-items:center;gap:3px;background:transparent;color:var(--dim);
  border:1px solid var(--border);border-radius:4px;padding:3px 9px;font-size:12px;
  cursor:pointer;transition:all .15s;font-family:var(--sans)}
.tbtn:hover{background:var(--panel);color:var(--text);border-color:var(--dim)}
.kbadge{font-family:var(--mono);font-size:11px;color:var(--dim);background:var(--bg);
  border:1px solid var(--border);border-radius:3px;padding:1px 5px}

/* TABS */
#etabs{display:flex;background:var(--sb);border-bottom:1px solid var(--border);
  overflow-x:auto;flex-shrink:0;scrollbar-width:none}
#etabs::-webkit-scrollbar{display:none}
.etab{display:flex;align-items:center;gap:5px;padding:0 12px;height:32px;
  font-size:12px;font-family:var(--mono);color:var(--dim);cursor:pointer;
  border-right:1px solid var(--border);white-space:nowrap;flex-shrink:0;
  transition:background .1s;user-select:none}
.etab:hover{background:rgba(255,255,255,.04);color:var(--text)}
.etab.on{background:var(--ed);color:#fff;border-bottom:2px solid var(--acc)}
.etab .x{width:13px;height:13px;border-radius:2px;display:flex;align-items:center;
  justify-content:center;font-size:10px;opacity:0;transition:opacity .1s}
.etab:hover .x,.etab.on .x{opacity:1}
.etab .x:hover{background:rgba(243,139,168,.25);color:var(--red)}

/* EDITOR + OUTPUT */
#sp{flex:1;display:flex;flex-direction:column;overflow:hidden}
#ew{flex:1;overflow:hidden;min-height:0;position:relative}

/* ‚îÄ‚îÄ CUSTOM CODE EDITOR ‚îÄ‚îÄ */
#editor-wrap{position:relative;height:100%;display:flex;background:var(--ed)}
#cur-line{position:absolute;left:0;right:0;height:calc(14px * 1.75);
  background:rgba(255,255,255,.04);pointer-events:none;z-index:1;
  border-left:2px solid rgba(0,212,170,.5);transition:top .05s}
#line-nums{
  width:46px;padding:12px 0;font-family:var(--mono);font-size:14px;
  line-height:1.75;color:#4a5070;background:#21252b;
  border-right:1px solid var(--border);text-align:right;
  padding-right:10px;overflow:hidden;flex-shrink:0;user-select:none;
  white-space:pre;
}
#code-area{
  flex:1;position:relative;overflow:hidden;
}
/* highlight background ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö string */
#code-bg .string{
  background:rgba(255,217,102,.07);
  border-radius:2px;
}
#code-bg .comment{
  background:rgba(124,133,168,.06);
  border-radius:2px;
}
#code-bg{
  position:absolute;top:0;left:0;right:0;bottom:0;
  padding:12px 14px;font-family:var(--mono);font-size:14px;
  line-height:1.75;white-space:pre;overflow:hidden;
  pointer-events:none;color:transparent;word-break:break-all;
}
#code-input{
  position:absolute;top:0;left:0;right:0;bottom:0;
  padding:12px 14px;font-family:var(--mono);font-size:14px;
  line-height:1.75;background:transparent;border:none;outline:none;
  color:#abb2bf;resize:none;white-space:pre;overflow:auto;
  caret-color:var(--acc);tab-size:4;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;
}
#code-input::selection{background:rgba(0,212,170,.2)}
#code-input::-webkit-scrollbar{width:6px;height:6px}
#code-input::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Python syntax highlight ‚Äî maximum contrast palette */
.kw     { color:#c678dd; font-weight:600 }           /* keyword    ‚Äî One Dark purple  */
.builtin{ color:#56b6c2 }                             /* builtin    ‚Äî One Dark cyan    */
.string { color:#98c379 }                             /* string     ‚Äî One Dark green   */
.comment{ color:#5c6370; font-style:italic }          /* comment    ‚Äî One Dark grey    */
.num    { color:#d19a66 }                             /* number     ‚Äî One Dark orange  */
.op     { color:#abb2bf }                             /* operator   ‚Äî One Dark white   */
.dec    { color:#e5c07b; font-weight:600 }            /* decorator  ‚Äî One Dark yellow  */
.fn     { color:#61afef }                             /* fn call    ‚Äî One Dark blue    */

#resizer{height:4px;background:var(--border);cursor:ns-resize;flex-shrink:0}
#resizer:hover,#resizer.drag{background:var(--acc)}

/* OUTPUT */
#outp{height:200px;display:flex;flex-direction:column;background:var(--ed);flex-shrink:0}
#otabs{display:flex;align-items:center;background:var(--panel);
  border-top:1px solid var(--border);border-bottom:1px solid var(--border);
  padding:0 6px;gap:2px;flex-shrink:0}
.otab{padding:5px 12px;font-size:12px;color:var(--dim);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .15s;user-select:none}
.otab.on{color:var(--acc);border-bottom-color:var(--acc)}
.clrbtn{background:transparent;border:none;color:var(--dim);cursor:pointer;
  padding:2px 6px;border-radius:3px;font-size:13px;margin-left:auto}
.clrbtn:hover{color:var(--red)}
.opane{flex:1;overflow-y:auto;display:flex;flex-direction:column}
.opane::-webkit-scrollbar{width:5px}
.opane::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
#cout{padding:8px 12px;font-family:var(--mono);font-size:12px;line-height:1.7}
.ol{display:flex}.os{color:var(--text)}.oe{color:var(--red)}.oi{color:var(--dim);font-style:italic}.og{color:var(--green)}
#gout{background:var(--ed);overflow-y:auto;padding:8px;gap:6px;flex-direction:column;align-items:center}
.gitem{width:100%;max-width:540px;background:var(--panel);border:1px solid var(--border);border-radius:7px;overflow:hidden}
.ghdr{display:flex;align-items:center;justify-content:space-between;padding:5px 9px;
  background:var(--bg);border-bottom:1px solid var(--border);font-size:11px;
  color:var(--dim);font-family:var(--mono)}
.gitem img{width:100%;display:block}
.gdl{background:transparent;border:1px solid var(--border);color:var(--dim);
  padding:2px 8px;border-radius:3px;font-size:11px;cursor:pointer}
.gdl:hover{border-color:var(--acc);color:var(--acc)}
#gbadge{display:none;background:var(--acc);color:#000;border-radius:9px;
  padding:0 5px;font-size:10px;margin-left:3px;font-weight:700}

/* AI PANEL */
#ai{width:320px;background:var(--panel);border-left:1px solid var(--border);
  display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;transition:width .18s}
#ai.hide{width:0;overflow:hidden}
#aihdr{padding:9px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;flex-shrink:0}
.ait{font-weight:600;font-size:14px;color:#fff;flex:1}
.aix{background:transparent;border:none;color:var(--dim);cursor:pointer;font-size:14px;padding:2px 5px;border-radius:3px}
.aix:hover{color:var(--red)}
#aimodes{display:flex;background:var(--bg);padding:4px 5px;gap:2px;flex-shrink:0;
  border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
#aimodes::-webkit-scrollbar{display:none}
.amb{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500;cursor:pointer;
  border:1px solid transparent;background:transparent;color:var(--dim);transition:all .15s;white-space:nowrap}
.amb.on{background:var(--panel);color:var(--acc);border-color:var(--border)}
.amb:hover:not(.on){color:var(--text)}
#aic{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:8px;gap:7px}
.aiw{display:flex;flex-direction:column;gap:4px;flex-shrink:0}
.ail{font-size:11px;color:var(--dim);font-weight:500}
.aita{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:7px;
  color:var(--text);font-family:var(--mono);font-size:12px;resize:none;outline:none;line-height:1.5}
.aita:focus{border-color:var(--acc)}
.aitin{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 9px;
  color:var(--text);font-size:12px;outline:none;width:100%}
.aitin:focus{border-color:var(--acc)}
.peb{background:transparent;border:1px dashed var(--border);border-radius:4px;padding:4px 8px;
  color:var(--dim);font-size:11px;cursor:pointer;transition:all .15s;text-align:center}
.peb:hover{border-color:var(--acc);color:var(--acc)}
.asb{width:100%;padding:7px;border-radius:6px;border:none;font-weight:600;font-size:13px;
  cursor:pointer;transition:filter .15s;background:var(--acc);color:#000;font-family:var(--sans)}
.asb:hover{filter:brightness(1.1)}
.asb.r{background:var(--red);color:#fff}
.asb.g{background:var(--green);color:#000}
.asb.p{background:var(--pur);color:#000}
#aow{flex:1;overflow-y:auto;border:1px solid var(--border);border-radius:6px;
  background:var(--bg);padding:8px;min-height:0}
#aow::-webkit-scrollbar{width:4px}
#aow::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
#aout{font-size:12px;line-height:1.65;color:var(--text)}
#aout h1,#aout h2{color:#fff;font-size:14px;font-weight:600;margin:6px 0 3px}
#aout p{margin-bottom:6px}
#aout pre{background:#0a0c10;border:1px solid var(--border);color:var(--text);
  padding:8px;border-radius:4px;overflow-x:auto;margin-bottom:6px;font-size:11px}
#aout code{font-family:var(--mono);background:#0a0c10;color:var(--acc);
  padding:1px 4px;border-radius:3px;font-size:11px}
#aout pre code{background:transparent;color:var(--text);padding:0}
#aout ul,#aout ol{margin-left:1rem;margin-bottom:6px}
#aout strong{color:#fff;font-weight:600}
.aph{color:var(--dim);font-size:12px;text-align:center;margin-top:12px;font-style:italic}
.ald{display:flex;align-items:center;gap:5px;color:var(--dim);font-size:12px;padding:6px 0}
.ald span{width:5px;height:5px;border-radius:50%;background:var(--acc);animation:db 1.2s infinite}
.ald span:nth-child(2){animation-delay:.2s}.ald span:nth-child(3){animation-delay:.4s}
@keyframes db{0%,80%,100%{transform:scale(.8);opacity:.4}40%{transform:scale(1.2);opacity:1}}

/* FLOWCHART */
#fcw{display:none;flex:1;overflow:hidden;flex-direction:column;
  border:1px solid var(--border);border-radius:6px;background:var(--bg)}
#fctb{display:flex;align-items:center;gap:4px;padding:5px 7px;
  background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0}
#fcc-w{flex:1;overflow:auto}
#fcc-w::after{content:'üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà shape ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';display:block;text-align:center;font-size:10px;color:var(--dim);padding:4px 0 8px;font-family:var(--mono)}
#fcc{transform-origin:top left;transition:transform .15s;padding:14px}

/* STATUS */
#stat{height:21px;background:var(--acc);color:#000;display:flex;align-items:center;
  padding:0 10px;gap:12px;font-size:11px;font-weight:600;flex-shrink:0}
.sp{opacity:.3}

/* TOAST */
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(6px);
  background:var(--panel);border:1px solid var(--border);color:var(--text);padding:6px 14px;
  border-radius:6px;font-size:12px;opacity:0;transition:all .2s;pointer-events:none;z-index:9999}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:720px){#ai,#fe{display:none}#side{width:38px}}

/* SETTINGS MODAL */
#settings-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;display:none;align-items:center;justify-content:center}
#settings-modal.on{display:flex}
#settings-box{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:20px;width:360px;display:flex;flex-direction:column;gap:12px}
.s-title{font-weight:700;font-size:15px;color:#fff}
.s-lbl{font-size:11px;color:var(--dim);font-weight:600;margin-bottom:3px}
.s-inp{background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:var(--mono);font-size:12px;padding:6px 10px;outline:none;width:100%}
.s-inp:focus{border-color:var(--acc)}
.s-row{display:flex;gap:8px}
.s-save{flex:1;padding:7px;border-radius:5px;border:none;background:var(--acc);color:#000;font-weight:700;font-size:13px;cursor:pointer}
.s-save:hover{filter:brightness(1.1)}
.s-cancel{padding:7px 14px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--dim);font-size:13px;cursor:pointer}
.s-cancel:hover{color:var(--text)}
.s-hint{font-size:11px;color:var(--dim);line-height:1.5}
.s-hint a{color:var(--acc);text-decoration:none}
.s-hint a:hover{text-decoration:underline}
</style>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
<script type="importmap">{"imports":{"@google/generative-ai":"https://esm.run/@google/generative-ai"}}</script>
</head>
<body>

<div id="tb">
  <div class="logo">üêç Pygram<b>IDE</b></div>
  <div class="filetab"><span class="dot"></span><span id="ftxt">main.py</span></div>
  <div class="ltog">
    <button class="lbtn on" id="l-th" onclick="setL('th')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
    <button class="lbtn" id="l-en" onclick="setL('en')">üá¨üáß EN</button>
  </div>

</div>

<div id="ws">
  <div id="side">
    <button class="sbtn on" id="sb-f" onclick="togEx()" title="Explorer">üìÅ</button>
    <button class="sbtn" onclick="run()" title="Run (Ctrl+Enter)">‚ñ∂</button>
    <button class="sbtn" onclick="clrOut()" title="Clear">üóë</button>
    <button class="sbtn" onclick="cpCode()" title="Copy">üìã</button>
    <button class="sbtn" onclick="loadSamp()" title="Sample">üìÑ</button>
    <div style="flex:1"></div>
    <button class="sbtn" onclick="togSettings()" id="sb-set" title="‚öô API Settings">‚öô</button>
    <button class="sbtn on" id="sb-ai" onclick="togAI()" title="AI Assistant">‚ú®</button>
  </div>

  <div id="fe">
    <div id="fe-hdr">
      <span data-i18n="explorer">Explorer</span>
      <div style="display:flex;gap:2px">
        <button class="fe-hbtn" onclick="nf()" title="New File">Ôºã</button>
        <button class="fe-hbtn" onclick="nfTpl()" title="From Template">‚äû</button>
      </div>
    </div>
    <div id="fe-root" onclick="togFold()">
      <span id="fe-arr" class="o">‚ñ∂</span><span>üìÅ</span><span>PROJECT</span>
    </div>
    <div id="fe-list"></div>
  </div>

  <div id="ea">
    <div id="toolbar">
      <button class="rbtn" id="rbtn" onclick="run()">
        <span id="rico">‚ñ∂</span><span id="rtxt" data-i18n="run">‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</span>
        <span class="kbadge">Ctrl+Enter</span>
      </button>
      <button class="tbtn" onclick="clrOut()" data-i18n="clrBtn">üóë ‡∏•‡πâ‡∏≤‡∏á</button>
      <button class="tbtn" onclick="cpCode()" data-i18n="copyBtn">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
      <button class="tbtn" onclick="loadSamp()" data-i18n="sampleBtn">üìÑ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
      <div style="flex:1"></div>

      <button class="tbtn" onclick="togAI()" data-i18n="aiBtn">‚ú® AI</button>
    </div>
    <div id="etabs"></div>
    <div id="sp">
      <div id="ew">
        <div id="editor-wrap">
          <div id="line-nums">1</div>
          <div id="code-area">
            <div id="cur-line"></div>
            <div id="code-bg"></div>
            <textarea id="code-input" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
          </div>
        </div>
      </div>
      <div id="resizer"></div>
      <div id="outp">
        <div id="otabs">
          <div class="otab on" id="ot-c" onclick="swOut('c')" data-i18n="consoleTab">üñ• Console</div>
          <div class="otab" id="ot-g" onclick="swOut('g')" data-i18n="graphTab">üìä Graph<span id="gbadge">‚óè</span></div>
          <div style="flex:1"></div>
          <button class="clrbtn" onclick="clrOut()">üóë</button>
        </div>
        <div id="cout" class="opane"></div>
        <div id="gout" class="opane" style="display:none"></div>
      </div>
    </div>
  </div>

  <div id="ai">
    <div id="aihdr">
      <span>‚ú®</span><div class="ait" data-i18n="aiTitle">AI Assistant</div>
      <button class="aix" onclick="togAI()">‚úï</button>
    </div>
    <div id="aimodes">
      <button class="amb on" onclick="setM('explain')" data-i18n="mExplain">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</button>
      <button class="amb" onclick="setM('debug')" data-i18n="mDebug">‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å</button>
      <button class="amb" onclick="setM('theory')" data-i18n="mTheory">‡∏ó‡∏§‡∏©‡∏é‡∏µ</button>
      <button class="amb" onclick="setM('algo')" data-i18n="mAlgo">Algorithm</button>
      <button class="amb" onclick="setM('fc')" data-i18n="mFlow">üîÄ Flow</button>
    </div>
    <div id="aic">
      <div id="m-explain" class="aiw">
        <div class="ail" data-i18n="explainLabel">‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</div>
        <button class="peb" onclick="pull('e-code')" data-i18n="pullCode">‚Üê ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Editor</button>
        <textarea class="aita" id="e-code" rows="6" data-i18n-ph="pastePh" placeholder="‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        <button class="asb" onclick="doExplain()" data-i18n="doExplain">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ</button>
      </div>
      <div id="m-debug" class="aiw" style="display:none">
        <div class="ail" data-i18n="debugLabel">‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
        <button class="peb" onclick="pull('d-code')" data-i18n="pullCode">‚Üê ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Editor</button>
        <textarea class="aita" id="d-code" rows="5" data-i18n-ph="pastePh2" placeholder="‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î..."></textarea>
        <div class="ail" style="margin-top:3px" data-i18n="errMsgLabel">Error Message</div>
        <textarea class="aita" id="d-err" rows="2" placeholder="Traceback..." style="color:#f38ba8"></textarea>
        <button class="asb r" onclick="doDebug()" data-i18n="doDebug">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</button>
      </div>
      <div id="m-theory" class="aiw" style="display:none">
        <div class="ail" data-i18n="theoryLabel">‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡∏õ‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        <input class="aitin" id="t-in" data-i18n-ph="theoryPh" placeholder="‡πÄ‡∏ä‡πà‡∏ô OOP, Recursion...">
        <button class="asb g" onclick="doTheory()" style="margin-top:3px" data-i18n="doTheory">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ + ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
      </div>
      <div id="m-algo" class="aiw" style="display:none">
        <div class="ail">Data Structure / Algorithm</div>
        <input class="aitin" id="a-in" data-i18n-ph="algoPh" placeholder="‡πÄ‡∏ä‡πà‡∏ô Quick Sort, Binary Tree...">
        <button class="asb p" onclick="doAlgo()" style="margin-top:3px" data-i18n="doAlgo">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
      <div id="m-fc" class="aiw" style="display:none">
        <div class="ail" data-i18n="fcLabel">‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á</div>
        <button class="peb" onclick="pull('fc-code')" data-i18n="pullCode">‚Üê ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Editor</button>
        <textarea class="aita" id="fc-code" rows="5" data-i18n-ph="pastePh" placeholder="‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î Python..."></textarea>
        <div class="ail" style="margin-top:3px" data-i18n="fcErrLabel">Error (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
        <textarea class="aita" id="fc-err" rows="2" placeholder="Traceback..." style="color:#f38ba8"></textarea>
        <button class="asb" onclick="doFC()" style="background:linear-gradient(135deg,#00d4aa,#89b4fa);color:#000" data-i18n="doFC">üîÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á Flowchart</button>
      </div>
      <div id="aow"><div id="aout"><p class="aph" data-i18n="aiPh">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å AI ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</p></div></div>
      <div id="fcw">
        <div id="fctb">
          <span style="font-size:11px;color:var(--dim);flex:1" id="fct">Flowchart</span>
          <button class="tbtn" onclick="fcZ(.15)" style="padding:2px 7px;font-size:11px">Ôºã</button>
          <button class="tbtn" onclick="fcZ(-.15)" style="padding:2px 7px;font-size:11px">Ôºç</button>
          <button class="tbtn" onclick="fcFit()" style="padding:2px 7px;font-size:11px">‚ä°</button>
          <button class="tbtn" onclick="fcExp()" style="padding:2px 7px;font-size:11px">‚¨á</button>
        </div>
        <div id="fcc-w"><div id="fcc"></div></div>
      </div>
    </div>
  </div>
</div>

<div id="stat">
  <span>üêç Python 3</span><span class="sp">|</span>
  <span id="s-cur">Ln 1, Col 1</span><span class="sp">|</span>
  <span id="s-lc" data-i18n-lines="true">0 lines</span>
  <span id="s-run" style="margin-left:auto" data-i18n="sRun">üêç Pyodide ready ¬∑ AI: Gemini</span>
</div>
<div id="toast"></div>
<div id="ctx">
  <div class="ci" onclick="cRename()" data-i18n="ctxRename">‚úèÔ∏è Rename</div>
  <div class="ci" onclick="cDup()" data-i18n="ctxDup">‚ßâ Duplicate</div>
  <div class="cs"></div>
  <div class="ci d" onclick="cDel()" data-i18n="ctxDel">üóë Delete</div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ marked.js inline (minimal subset) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// We inline a tiny markdown renderer instead of loading CDN
function md2html(t){
  return t
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```[\w]*\n?([\s\S]*?)```/g,(_,c)=>`<pre><code>${c.trim()}</code></pre>`)
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^[-*] (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>[\s\S]+?<\/li>)/g,'<ul>$1</ul>')
    .replace(/\n\n/g,'</p><p>')
    .replace(/^(?!<[a-z])/gm,'<p>').replace(/(?<![>])$/gm,'</p>')
    .replace(/<p><\/p>/g,'');
}

// ‚îÄ‚îÄ‚îÄ SYNTAX HIGHLIGHT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const KW=['False','None','True','and','as','assert','async','await','break','class',
  'continue','def','del','elif','else','except','finally','for','from','global',
  'if','import','in','is','lambda','nonlocal','not','or','pass','raise','return',
  'try','while','with','yield'];
const BUILTINS=['print','len','range','int','str','float','list','dict','tuple','set',
  'bool','type','input','open','abs','max','min','sum','sorted','reversed','enumerate',
  'zip','map','filter','format','repr','isinstance','issubclass','hasattr','getattr',
  'setattr','append','extend','super','property','staticmethod','classmethod'];

function highlight(code){
  const KW_SET=new Set(KW);
  const BI_SET=new Set(BUILTINS);
  return code.split('\n').map(line=>{
    // Escape HTML
    line=line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    let out='',i=0,len=line.length;
    while(i<len){
      // Comment
      if(line[i]==='#'){out+=`<span class="comment">${line.slice(i)}</span>`;break;}
      // f/r/b prefix strings
      if(/[frbuFRBU]/.test(line[i])&&i+1<len&&(line[i+1]==='"'||line[i+1]==="'")){
        const prefix=line[i],q=line[i+1];
        let j=i+2,s=prefix+q;
        while(j<len){if(line[j]==='\\'){s+=line[j]+line[j+1];j+=2;continue;}s+=line[j];if(line[j]===q){j++;break;}j++;}
        out+=`<span class="string">${s}</span>`;i=j;continue;
      }
      // String
      if(line[i]==='"'||line[i]==="'"){
        const q=line[i];let j=i+1,s=q;
        while(j<len){if(line[j]==='\\'){s+=line[j]+line[j+1];j+=2;continue;}s+=line[j];if(line[j]===q){j++;break;}j++;}
        out+=`<span class="string">${s}</span>`;i=j;continue;
      }
      // Number
      if(line[i]>='0'&&line[i]<='9'){
        let j=i;
        while(j<len&&/[\d.xXoObBeEa-fA-F_]/.test(line[j]))j++;
        out+=`<span class="num">${line.slice(i,j)}</span>`;i=j;continue;
      }
      // Decorator
      if(line[i]==='@'){
        let j=i+1;while(j<len&&/\w/.test(line[j]))j++;
        out+=`<span class="dec">${line.slice(i,j)}</span>`;i=j;continue;
      }
      // Word ‚Üí keyword / builtin / function call / identifier
      if(/[a-zA-Z_]/.test(line[i])){
        let j=i;while(j<len&&/\w/.test(line[j]))j++;
        const w=line.slice(i,j);
        // ‡∏°‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ ( ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡πÑ‡∏´‡∏°
        let k=j;while(k<len&&line[k]===' ')k++;
        const isFnCall=line[k]==='(';
        if(KW_SET.has(w))out+=`<span class="kw">${w}</span>`;
        else if(BI_SET.has(w)&&isFnCall)out+=`<span class="builtin">${w}</span>`;
        else if(BI_SET.has(w))out+=`<span class="builtin">${w}</span>`;
        else if(isFnCall)out+=`<span class="fn">${w}</span>`;
        else out+=w;
        i=j;continue;
      }
      // Operator
      if('+-*/%=<>!&|^~'.includes(line[i])){out+=`<span class="op">${line[i]}</span>`;i++;continue;}
      // Other (spaces, brackets, Thai chars, etc.)
      out+=line[i];i++;
    }
    return out;
  }).join('\n');
}

// ‚îÄ‚îÄ‚îÄ LANG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LNG={
  th:{run:'‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î',running:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô...',done:ms=>`‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô ${ms}ms`,
    noOut:'‚ñ∏ ‡∏£‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏°‡∏µ output)',err:'Error:',
    pEx:c=>`‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î Python ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢\n\`\`\`python\n${c}\n\`\`\``,
    pDbg:(c,e)=>`‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡∏∞ Error ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢:\n\`\`\`python\n${c}\n\`\`\`\nError: ${e}\n‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ ‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß`,
    pTh:v=>`‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ "${v}" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ CS ‡∏õ‡∏µ 1-2 ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏Ñ‡πâ‡∏î Python ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á`,
    pAl:v=>`‡∏™‡∏£‡∏∏‡∏õ "${v}" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ CS ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢: 1.‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î 2.Use case 3.Big O 4.‡∏Ç‡πâ‡∏≠‡∏î‡∏µ/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢`},
  en:{run:'Run Code',running:'Running...',done:ms=>`‚úì Done in ${ms}ms`,
    noOut:'‚ñ∏ Finished (no output)',err:'Error:',
    pEx:c=>`Explain this Python code for beginners, then summarize.\n\`\`\`python\n${c}\n\`\`\``,
    pDbg:(c,e)=>`Analyze code and error:\n\`\`\`python\n${c}\n\`\`\`\nError: ${e}\nExplain bug and provide fix.`,
    pTh:v=>`Explain "${v}" for CS students with a Python example.`,
    pAl:v=>`Summarize "${v}" for CS: 1.Concept 2.Use cases 3.Big O 4.Pros&Cons`}
};
let lang=localStorage.getItem('pgl')||'th';
const T=()=>LNG[lang];
// ‚îÄ‚îÄ‚îÄ UI TRANSLATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const UI={
  th:{
    explorer:'Explorer', run:'‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î', clrBtn:'üóë ‡∏•‡πâ‡∏≤‡∏á', copyBtn:'üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',
    sampleBtn:'üìÑ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', aiBtn:'‚ú® AI', consoleTab:'üñ• Console', graphTab:'üìä Graph',
    aiTitle:'AI Assistant', mExplain:'‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢', mDebug:'‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å', mTheory:'‡∏ó‡∏§‡∏©‡∏é‡∏µ',
    mAlgo:'Algorithm', mFlow:'üîÄ Flow',
    explainLabel:'‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢', pullCode:'‚Üê ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Editor',
    pastePh:'‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...', pastePh2:'‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î...',
    doExplain:'‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ', debugLabel:'‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', doDebug:'‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
    theoryLabel:'‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡∏õ‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', theoryPh:'‡πÄ‡∏ä‡πà‡∏ô OOP, Recursion...',
    doTheory:'‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ + ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', algoPh:'‡πÄ‡∏ä‡πà‡∏ô Quick Sort, Binary Tree...',
    doAlgo:'‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', fcLabel:'‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á', doFC:'üîÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á Flowchart',
    aiPh:'‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å AI ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...',
    sRun:'üêç Pyodide ready ¬∑ AI: Gemini',
    ctxRename:'‚úèÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠', ctxDup:'‚ßâ ‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤', ctxDel:'üóë ‡∏•‡∏ö',
    saveKey:'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', newFile:'‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà', fromTemplate:'‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï',
    sbExplorer:'Explorer', sbRun:'‡∏£‡∏±‡∏ô (Ctrl+Enter)', sbClear:'‡∏•‡πâ‡∏≤‡∏á', sbCopy:'‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',
    sbSample:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', sbAI:'AI Assistant',
    fcErrLabel:'Error (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)', errMsgLabel:'Error Message', linesUnit:'‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î'
  },
  en:{
    explorer:'Explorer', run:'Run Code', clrBtn:'üóë Clear', copyBtn:'üìã Copy',
    sampleBtn:'üìÑ Sample', aiBtn:'‚ú® AI', consoleTab:'üñ• Console', graphTab:'üìä Graph',
    aiTitle:'AI Assistant', mExplain:'Explain', mDebug:'Debug', mTheory:'Theory',
    mAlgo:'Algorithm', mFlow:'üîÄ Flow',
    explainLabel:'Code to explain', pullCode:'‚Üê Pull from Editor',
    pastePh:'Paste code here...', pastePh2:'Paste code...',
    doExplain:'Explain this code', debugLabel:'Problematic code', doDebug:'Analyze error',
    theoryLabel:'Concept to learn', theoryPh:'e.g. OOP, Recursion...',
    doTheory:'Explain + Example code', algoPh:'e.g. Quick Sort, Binary Tree...',
    doAlgo:'Summarize', fcLabel:'Code to visualize', doFC:'üîÄ Generate Flowchart',
    aiPh:'AI output will appear here...',
    sRun:'üêç Pyodide ready ¬∑ AI: Gemini',
    ctxRename:'‚úèÔ∏è Rename', ctxDup:'‚ßâ Duplicate', ctxDel:'üóë Delete',
    saveKey:'üíæ Save', newFile:'New File', fromTemplate:'From Template',
    sbExplorer:'Explorer', sbRun:'Run (Ctrl+Enter)', sbClear:'Clear', sbCopy:'Copy',
    sbSample:'Sample', sbAI:'AI Assistant',
    fcErrLabel:'Error (if any)', errMsgLabel:'Error Message', linesUnit:'lines'
  }
};

function applyI18n(l){
  const t=UI[l];
  // text content
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n');
    if(t[k]!==undefined) el.textContent=t[k];
  });
  // placeholder attributes
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const k=el.getAttribute('data-i18n-ph');
    if(t[k]!==undefined) el.placeholder=t[k];
  });
  // sidebar button tooltips
  const sbMap={
    'sb-f':'sbExplorer','sb-ai':'sbAI'
  };
  Object.entries(sbMap).forEach(([id,k])=>{
    const el=document.getElementById(id);
    if(el&&t[k]) el.title=t[k];
  });
  // sidebar non-id buttons by their position (run, clear, copy, sample)
  const sbBtns=document.querySelectorAll('#side .sbtn:not(#sb-f):not(#sb-ai)');
  const sbKeys=['sbRun','sbClear','sbCopy','sbSample'];
  sbBtns.forEach((btn,i)=>{ if(sbKeys[i]&&t[sbKeys[i]]) btn.title=t[sbKeys[i]]; });
  // lines counter
  const slc=document.getElementById('s-lc');
  if(slc){ const m=slc.textContent.match(/\d+/); const n=m?m[0]:'0'; slc.textContent=`${n} ${t.linesUnit}`; }
  // html lang attribute
  document.documentElement.lang=l;
}

function setL(l){lang=l;localStorage.setItem('pgl',l);
  document.getElementById('l-th').classList.toggle('on',l==='th');
  document.getElementById('l-en').classList.toggle('on',l==='en');
  applyI18n(l);
}

// ‚îÄ‚îÄ‚îÄ FILE SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEF=`# üêç Pygram IDE ‚Äî ‡∏Å‡∏î Ctrl+Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô
# Claude ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

def greet(name):
    return f"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, {name}! üéâ"

nums = [1, 2, 3, 4, 5]
sq = [n**2 for n in nums]

print(greet("‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô CS"))
print("Squares:", sq)
print("Sum:", sum(sq))

def fib(n):
    a,b=0,1
    res=[]
    for _ in range(n):
        res.append(a);a,b=b,a+b
    return res

print("Fibonacci:", fib(10))
`;
let files=[{name:'main.py',content:DEF}];
let tabs=['main.py'],act='main.py',ctxT=null,exOpen=true,foldOpen=true;
const gf=n=>files.find(f=>f.name===n);
const ico=n=>n.endsWith('.py')?'üêç':n.endsWith('.json')?'{}':n.endsWith('.md')?'üìù':'üìÑ';
function getCode(){return document.getElementById('code-input').value;}
function syncFile(){const f=gf(act);if(f)f.content=getCode();}

function renderFL(){
  const el=document.getElementById('fe-list');el.innerHTML='';
  if(!foldOpen)return;
  files.forEach(f=>{
    const d=document.createElement('div');
    d.className='fitem'+(f.name===act?' on':'');d.dataset.n=f.name;
    d.innerHTML=`<span>${ico(f.name)}</span><span class="fn-txt">${f.name}</span>`;
    d.onclick=e=>{e.stopPropagation();openTab(f.name)};
    d.oncontextmenu=e=>{e.preventDefault();showCtx(e,f.name)};
    el.appendChild(d);
  });
}
function renderTabs(){
  const bar=document.getElementById('etabs');bar.innerHTML='';
  tabs.forEach(name=>{
    const f=gf(name);if(!f)return;
    const t=document.createElement('div');t.className='etab'+(name===act?' on':'');
    t.innerHTML=`<span>${ico(name)}</span><span>${name}</span><span class="x">‚úï</span>`;
    t.onclick=e=>{if(e.target.classList.contains('x'))return;openTab(name)};
    t.querySelector('.x').onclick=e=>{e.stopPropagation();closeTab(name)};
    bar.appendChild(t);
  });
  document.getElementById('ftxt').textContent=act||'';
}
function setEditorVal(val){
  const inp=document.getElementById('code-input');
  inp.value=val;
  updateHL();updateLN();updStat();
}
function openTab(name){
  syncFile();act=name;
  if(!tabs.includes(name))tabs.push(name);
  const f=gf(name);if(f)setEditorVal(f.content);
  renderTabs();renderFL();document.getElementById('code-input').focus();
}
function closeTab(name){
  if(name===act)syncFile();
  tabs=tabs.filter(t=>t!==name);
  if(act===name){
    act=tabs[tabs.length-1]||null;
    if(act){const f=gf(act);if(f)setEditorVal(f.content);}
    else setEditorVal('');
  }
  renderTabs();renderFL();
}
function nf(name){
  if(!name){name=prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå:','module.py');if(!name)return;if(!name.includes('.'))name+='.py';}
  if(gf(name)){toast(`${name} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);return;}
  files.push({name,content:`# ${name}\n`});renderFL();openTab(name);toast(`‡∏™‡∏£‡πâ‡∏≤‡∏á ${name}`);
}
function nfTpl(){
  const ts={'utils.py':'def add(a,b): return a+b\ndef sub(a,b): return a-b\n','class_ex.py':'class Animal:\n    def __init__(self,n):\n        self.name=n\n    def speak(self):\n        return f"{self.name} makes a sound"\n\nprint(Animal("Dog").speak())\n'};
  const k=Object.keys(ts);
  const c=prompt(k.map((n,i)=>`${i+1}. ${n}`).join('\n')+'\n‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç:');
  const i=parseInt(c)-1;if(isNaN(i)||i<0||i>=k.length)return;
  let n=k[i],cnt=1;while(gf(n))n=k[i].replace('.',`_${cnt++}.`);
  files.push({name:n,content:ts[k[i]]});renderFL();openTab(n);
}
function togEx(){exOpen=!exOpen;document.getElementById('fe').classList.toggle('hide',!exOpen);document.getElementById('sb-f').classList.toggle('on',exOpen);}
function togFold(){foldOpen=!foldOpen;document.getElementById('fe-arr').classList.toggle('o',foldOpen);renderFL();}
function showCtx(e,n){ctxT=n;const m=document.getElementById('ctx');m.style.display='block';m.style.left=Math.min(e.clientX,innerWidth-150)+'px';m.style.top=Math.min(e.clientY,innerHeight-110)+'px';}
function hideCtx(){document.getElementById('ctx').style.display='none';ctxT=null;}
document.addEventListener('click',hideCtx);document.addEventListener('keydown',e=>{if(e.key==='Escape')hideCtx();});
function cRename(){
  if(!ctxT)return;const old=ctxT;hideCtx();
  const el=document.querySelector(`.fitem[data-n="${old}"] .fn-txt`);if(!el)return;
  const inp=document.createElement('input');inp.className='fri';inp.value=old;
  el.replaceWith(inp);inp.focus();inp.select();
  const commit=()=>{
    let n=inp.value.trim();if(!n){renderFL();return;}
    if(!n.includes('.'))n+='.py';
    if(n!==old&&gf(n)){toast(`${n} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);renderFL();return;}
    if(n!==old){const f=gf(old);if(f)f.name=n;tabs=tabs.map(x=>x===old?n:x);if(act===old)act=n;}
    renderFL();renderTabs();
  };
  inp.onblur=commit;inp.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();commit();}if(e.key==='Escape')renderFL();};
}
function cDup(){
  if(!ctxT)return;const f=gf(ctxT);hideCtx();if(!f)return;
  const base=f.name.replace(/(\.\w+)$/,''),ext=f.name.match(/(\.\w+)$/)?.[1]||'.py';
  let n=base+'_copy'+ext,c=1;while(gf(n))n=base+'_copy'+(c++)+ext;
  files.splice(files.indexOf(f)+1,0,{name:n,content:f.content});renderFL();openTab(n);toast(`‚Üí ${n}`);
}
function cDel(){
  if(!ctxT)return;const name=ctxT;hideCtx();
  if(files.length===1){toast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå');return;}
  if(!confirm(`‡∏•‡∏ö "${name}" ?`))return;
  files=files.filter(f=>f.name!==name);closeTab(name);renderFL();toast(`‡∏•‡∏ö ${name}`);
}

// ‚îÄ‚îÄ‚îÄ EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHL(){
  const code=getCode();
  document.getElementById('code-bg').innerHTML=highlight(code)+'\n';
  // Sync scroll
  const inp=document.getElementById('code-input');
  document.getElementById('code-bg').scrollTop=inp.scrollTop;
}
function updateLN(){
  const lines=getCode().split('\n').length;
  document.getElementById('line-nums').textContent=Array.from({length:lines},(_,i)=>i+1).join('\n');
}
function updStat(){
  const inp=document.getElementById('code-input');
  const before=inp.value.slice(0,inp.selectionStart);
  const lines=before.split('\n');
  const ln=lines.length;
  document.getElementById('s-cur').textContent=`Ln ${ln}, Col ${lines[ln-1].length+1}`;
  document.getElementById('s-lc').textContent=`${inp.value.split('\n').length} ${UI[lang].linesUnit}`;
  // current line highlight
  const cl=document.getElementById('cur-line');
  if(cl){
    const lh=14*1.75; // font-size * line-height
    cl.style.top=(12+(ln-1)*lh-inp.scrollTop)+'px';
    cl.style.height=lh+'px';
  }
}

window.addEventListener('DOMContentLoaded',()=>{
  const inp=document.getElementById('code-input');
  inp.value=DEF;
  updateHL();updateLN();updStat();
  renderFL();renderTabs();setL(lang);initResizer();
  // Init run engine (always pyodide)
  runEngine='pyodide';
  if(!pyodideReady&&!pyodideLoading) initPyodide();
  // Load saved API key silently (still used by AI features)
  const savedKey=localStorage.getItem('pg_apikey')||'AIzaSyDLB6hKapWp5W8fU8CiWg3PV_SgmyrPbgY';
  if(savedKey) localStorage.setItem('pg_apikey',savedKey);
  const savedModel=localStorage.getItem('pg_model')||'gemini-1.5-flash';
  localStorage.setItem('pg_model', savedModel);

  inp.addEventListener('input',()=>{syncFile();updateHL();updateLN();updStat();});
  inp.addEventListener('scroll',()=>{
    document.getElementById('code-bg').scrollTop=inp.scrollTop;
    document.getElementById('code-bg').scrollLeft=inp.scrollLeft;
    document.getElementById('line-nums').scrollTop=inp.scrollTop;
  });
  inp.addEventListener('keydown',e=>{
    if(e.ctrlKey&&e.key==='Enter'){e.preventDefault();run();}
    if(e.ctrlKey&&e.key==='/'){e.preventDefault();toggleComment();}
    if(e.key==='Tab'){e.preventDefault();
      const s=inp.selectionStart,en=inp.selectionEnd;
      inp.value=inp.value.slice(0,s)+'    '+inp.value.slice(en);
      inp.selectionStart=inp.selectionEnd=s+4;
      syncFile();updateHL();updateLN();
    }
  });
  inp.addEventListener('keyup',updStat);
  inp.addEventListener('click',updStat);

  pln('‚ö° Pygram IDE ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî Claude ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ','og');
});

function toggleComment(){
  const inp=document.getElementById('code-input');
  const s=inp.selectionStart,en=inp.selectionEnd;
  const before=inp.value.slice(0,s),after=inp.value.slice(en);
  const sel=inp.value.slice(s,en)||inp.value.slice(inp.value.lastIndexOf('\n',s-1)+1,inp.value.indexOf('\n',s));
  const lines=sel.split('\n');
  const allCommented=lines.every(l=>l.trimStart().startsWith('#'));
  const newLines=allCommented?lines.map(l=>l.replace(/^(\s*)# ?/,'$1')):lines.map(l=>l.replace(/^(\s*)/,'$1# '));
  inp.value=before+newLines.join('\n')+after;
  syncFile();updateHL();updateLN();
}

// ‚îÄ‚îÄ‚îÄ OUTPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let curOutTab='c',gcnt=0;
function swOut(tab){
  curOutTab=tab;
  document.getElementById('cout').style.display=tab==='c'?'flex':'none';
  document.getElementById('gout').style.display=tab==='g'?'flex':'none';
  document.getElementById('ot-c').classList.toggle('on',tab==='c');
  document.getElementById('ot-g').classList.toggle('on',tab==='g');
  if(tab==='g')document.getElementById('gbadge').style.display='none';
}
function pln(txt,cls='os'){
  const out=document.getElementById('cout');
  const el=document.createElement('div');el.className='ol '+cls;el.textContent=txt;
  out.appendChild(el);out.scrollTop=out.scrollHeight;
}
function clrOut(){
  if(curOutTab==='c'){document.getElementById('cout').innerHTML='';}
  else{document.getElementById('gout').innerHTML='<div style="color:var(--dim);font-size:12px;font-style:italic;text-align:center;margin-top:20px">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>';document.getElementById('gbadge').style.display='none';}
}
function addGraph(url,label){
  gcnt++;
  const ph=document.getElementById('gout').querySelector('div');
  if(ph&&ph.style.fontStyle==='italic')ph.remove();
  const w=document.createElement('div');w.className='gitem';
  const h=document.createElement('div');h.className='ghdr';
  h.innerHTML=`<span>üìä ${label||'Figure '+gcnt}</span>`;
  const b=document.createElement('button');b.className='gdl';b.textContent='‚¨á Save';
  b.onclick=()=>{const a=document.createElement('a');a.href=url;a.download=`fig_${gcnt}.png`;a.click();};
  h.appendChild(b);const img=document.createElement('img');img.src=url;
  w.appendChild(h);w.appendChild(img);
  document.getElementById('gout').appendChild(w);
  if(curOutTab!=='g')document.getElementById('gbadge').style.display='inline';
  swOut('g');
}

// ‚îÄ‚îÄ‚îÄ PYODIDE (Python in Browser) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pyodide=null, pyodideLoading=false, pyodideReady=false;

async function initPyodide(){
  if(pyodideReady||pyodideLoading)return;
  pyodideLoading=true;
  document.getElementById('s-run').textContent='‚è≥ ‡πÇ‡∏´‡∏•‡∏î Python engine (~10MB)...';
  try{
    // ‡∏£‡∏∞‡∏ö‡∏∏ indexURL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Pyodide ‡∏´‡∏≤ .wasm ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    pyodide=await loadPyodide({
      indexURL:'https://cdn.jsdelivr.net/pyodide/v0.26.4/full/'
    });
    // redirect stdout/stderr
    pyodide.runPython(`
import sys
class _Buf:
    def __init__(self): self.v=[]
    def write(self,s): self.v.append(str(s))
    def flush(self): pass
sys.stdout=_Buf()
sys.stderr=_Buf()
`);
    pyodideReady=true;
    pyodideLoading=false;
    document.getElementById('s-run').textContent='üêç Python ready';
    toast('‚úÖ Python engine ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß');
  }catch(e){
    pyodideLoading=false;
    pyodideReady=false;
    console.error('Pyodide init error:',e);
    document.getElementById('s-run').textContent='‚ö† ‡πÇ‡∏´‡∏•‡∏î Python engine ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
    throw e;
  }
}

async function runWithPyodide(code){
  if(!pyodideReady){
    await initPyodide();
    if(!pyodideReady) throw new Error('‡πÇ‡∏´‡∏•‡∏î Python engine ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö internet ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
  }

  // reset output buffers
  pyodide.runPython('sys.stdout.v=[]; sys.stderr.v=[]');

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ matplotlib ‡πÑ‡∏´‡∏°
  const hasMPL=/^[ \t]*(import\s+matplotlib|from\s+matplotlib|import\s+pyplot|from\s+.*import.*plt)/m.test(code);

  // ‡πÇ‡∏´‡∏•‡∏î packages ‡∏à‡∏≤‡∏Å import statements ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  try{ await pyodide.loadPackagesFromImports(code); }catch(e){ console.warn('loadPackagesFromImports:',e); }

  if(hasMPL){
    // ‡πÉ‡∏ä‡πâ Agg backend (non-interactive) ‡πÅ‡∏•‡πâ‡∏ß patch plt.show() ‡πÉ‡∏´‡πâ export PNG
    pyodide.runPython(`
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import io, base64
_pygram_figs=[]
def _show_patch(*a,**kw):
    buf=io.BytesIO()
    plt.savefig(buf,format='png',bbox_inches='tight',dpi=110)
    buf.seek(0)
    _pygram_figs.append('data:image/png;base64,'+base64.b64encode(buf.read()).decode())
    plt.clf()
plt.show=_show_patch
`);
  }

  // ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
  try{
    await pyodide.runPythonAsync(code);
  }catch(err){
    // ‡∏î‡∏∂‡∏á stderr ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ JS error message
    let msg='';
    try{ msg=pyodide.runPython('sys.stderr.v').toJs().join(''); }catch(_){}
    throw new Error(msg||err.message);
  }

  const stdout=pyodide.runPython('sys.stdout.v').toJs();
  const text=stdout.join('').trimEnd();
  let plots=[];
  if(hasMPL){
    try{ plots=pyodide.runPython('_pygram_figs').toJs(); }catch(_){}
  }
  return {text,plots};
}

// ‚îÄ‚îÄ‚îÄ GEMINI AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getApiKey(){return localStorage.getItem('pg_apikey')||'';}
function getModel(){return localStorage.getItem('pg_model')||'gemini-1.5-flash';}
function saveApiKey(key,model){
  if(key) localStorage.setItem('pg_apikey',key);
  if(model) localStorage.setItem('pg_model',model);
}

// Helper: call Gemini API via allorigins proxy (fixes CORS from file://)
async function geminiRequest(prompt, maxTokens=1500, systemInstruction=null){
  const key=getApiKey();
  if(!key) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Gemini API Key ‡∏Å‡πà‡∏≠‡∏ô');
  const modelName=getModel();
  const body={
    contents:[{role:'user',parts:[{text:prompt}]}],
    generationConfig:{maxOutputTokens:maxTokens,temperature:0.7}
  };
  if(systemInstruction) body.system_instruction={parts:[{text:systemInstruction}]};

  // ‡πÉ‡∏ä‡πâ corsproxy.io ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS ‡∏à‡∏≤‡∏Å file://
  const target=`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
  const res=await fetch(`https://corsproxy.io/?${encodeURIComponent(target)}`,
    {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}
  );
  if(!res.ok){
    const err=await res.json().catch(()=>({}));
    throw new Error(err.error?.message||`Gemini Error ${res.status}: ${res.statusText}`);
  }
  const d=await res.json();
  const text=d.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!text) throw new Error('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Gemini');
  return text;
}

// ‚îÄ‚îÄ‚îÄ RUN via Local AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function run(){
  syncFile();
  const code=getCode().trim();if(!code)return;
  const btn=document.getElementById('rbtn');
  btn.classList.add('run');
  document.getElementById('rico').textContent='‚è≥';
  document.getElementById('rtxt').textContent=T().running;
  document.getElementById('s-run').textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô...';

  const t0=Date.now();
  pln('','oi');pln(`‚ñ∂ ${act} [${runEngine==='pyodide'?'üêç Local':'ü§ñ AI'}]`,'oi');
  try{
    if(runEngine==='pyodide'){
      // ‚îÄ‚îÄ Pyodide engine (no AI needed) ‚îÄ‚îÄ
      const {text,plots}=await runWithPyodide(code);
      if(text){
        text.split('\n').forEach(line=>{
          const isE=/(error|traceback|exception)/i.test(line);
          pln(line,isE?'oe':'os');
        });
      } else pln(T().noOut,'oi');
      plots.forEach((url,idx)=>addGraph(url,`Figure ${gcnt+1}`));
    } else {
      // ‚îÄ‚îÄ AI engine (Gemini) ‚îÄ‚îÄ
      const others=files.filter(f=>f.name!==act&&f.name.endsWith('.py'));
      const ctx=others.length?'\n\nOther files:\n'+others.map(f=>`# ${f.name}\n${f.content}`).join('\n---\n'):'';
      const prompt=`You are a Python 3 interpreter. Execute the code and return ONLY the program output.\n\nRULES:\n- Return ONLY what print() would output, line by line\n- Show Python tracebacks exactly for errors\n- For matplotlib: after text output add ##PLOT## then: data:image/png;base64,<base64data>\n- If no output: return exactly: (no output)\n- NO explanation, NO commentary${ctx}\n\n\`\`\`python\n${code}\n\`\`\``;
      const raw=await geminiRequest(prompt,1500);
      const parts=raw.split(/##PLOT##/);
      const textOut=parts[0].trim();
      if(textOut&&textOut!=='(no output)'){
        textOut.split('\n').forEach(line=>{
          const isE=/(error|traceback|exception)/i.test(line);
          pln(line,isE?'oe':'os');
        });
      } else if(textOut==='(no output)')pln(T().noOut,'oi');
      for(let i=1;i<parts.length;i++){
        const m=parts[i].match(/(data:image\/png;base64,[A-Za-z0-9+/=]+)/);
        if(m)addGraph(m[1],`Figure ${gcnt+1}`);
      }
    }
    const ms=Date.now()-t0;
    pln(T().done(ms),'og');
    document.getElementById('s-run').textContent=`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô ${ms}ms`;
  }catch(err){
    pln(T().err,'oe');pln('  '+err.message,'oe');
    document.getElementById('s-run').textContent='‚ùå Error';
  }finally{
    btn.classList.remove('run');
    document.getElementById('rico').textContent='‚ñ∂';
    document.getElementById('rtxt').textContent=T().run;
  }
}

// ‚îÄ‚îÄ‚îÄ ENGINE SELECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let runEngine = 'pyodide';
function setEng(e){
  runEngine=e;
  localStorage.setItem('pgeng',e);
  if(e==='pyodide'&&!pyodideReady&&!pyodideLoading) initPyodide();
}

function cpCode(){navigator.clipboard.writeText(getCode());toast(lang==='th'?'‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!':'Copied!');}
function loadSamp(){
  const s=[
`# Bubble Sort
def bubble_sort(arr):
    n=len(arr)
    for i in range(n):
        for j in range(0,n-i-1):
            if arr[j]>arr[j+1]:
                arr[j],arr[j+1]=arr[j+1],arr[j]
    return arr

data=[64,34,25,12,22,11,90]
print("Before:",data)
print("After: ",bubble_sort(data))`,
`# Binary Search
def bsearch(arr,t):
    lo,hi=0,len(arr)-1
    while lo<=hi:
        m=(lo+hi)//2
        if arr[m]==t: return m
        elif arr[m]<t: lo=m+1
        else: hi=m-1
    return -1

nums=[2,3,4,10,40,55,70]
print("Find 10 ‚Üí",bsearch(nums,10))`,
`# Matplotlib (Claude will simulate)
import matplotlib.pyplot as plt
import numpy as np

x=np.linspace(0,2*np.pi,100)
plt.figure(figsize=(7,3))
plt.plot(x,np.sin(x),label='sin')
plt.plot(x,np.cos(x),label='cos')
plt.title('Trig Functions')
plt.legend();plt.grid(True,alpha=0.3)
plt.tight_layout()
plt.show()`];
  setEditorVal(s[Math.floor(Math.random()*s.length)]);
  syncFile();
  toast(lang==='th'?'‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß':'Sample loaded');
}
function toast(msg,d=2000){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('on');setTimeout(()=>el.classList.remove('on'),d);}
function initResizer(){
  const r=document.getElementById('resizer');
  const ew=document.getElementById('ew');
  const op=document.getElementById('outp');
  let sy,sh1,sh2,drag=false;
  r.addEventListener('mousedown',e=>{drag=true;sy=e.clientY;sh1=ew.offsetHeight;sh2=op.offsetHeight;r.classList.add('drag');document.body.style.userSelect='none';});
  document.addEventListener('mousemove',e=>{if(!drag)return;const dy=e.clientY-sy;ew.style.height=Math.max(80,sh1+dy)+'px';ew.style.flex='none';op.style.height=Math.max(50,sh2-dy)+'px';});
  document.addEventListener('mouseup',()=>{drag=false;r.classList.remove('drag');document.body.style.userSelect='';});
}

// ‚îÄ‚îÄ‚îÄ AI PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let aiOpen=true,aiMode='explain';
function togAI(){aiOpen=!aiOpen;document.getElementById('ai').classList.toggle('hide',!aiOpen);document.getElementById('sb-ai').classList.toggle('on',aiOpen);}
function togSettings(){
  const m=document.getElementById('settings-modal');
  const isOn=m.classList.toggle('on');
  if(isOn){
    document.getElementById('s-apikey').value=getApiKey();
    const sel=document.getElementById('s-model');
    if(sel) sel.value=getModel();
  }
}
function saveSettings(){
  const key=document.getElementById('s-apikey').value.trim();
  const model=document.getElementById('s-model').value;
  saveApiKey(key,model);
  toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
  togSettings();
}
async function testApiKey(){
  const key=document.getElementById('s-apikey').value.trim();
  const model=document.getElementById('s-model').value;
  const res=document.getElementById('s-test-result');
  res.style.color='var(--dim)';res.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
  try{
    const r=await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`,
      {method:'POST',headers:{'Content-Type':'application/json'},
       body:JSON.stringify({contents:[{role:'user',parts:[{text:'say hi'}]}],generationConfig:{maxOutputTokens:10}})}
    );
    if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error?.message||`HTTP ${r.status}`);}
    res.style.color='var(--green)';res.textContent='‚úÖ API Key ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ!';
  }catch(e){
    res.style.color='var(--red)';res.textContent='‚ùå '+e.message;
  }
}
function setM(m){
  aiMode=m;
  ['explain','debug','theory','algo','fc'].forEach(x=>{document.getElementById('m-'+x).style.display=x===m?'flex':'none';});
  document.querySelectorAll('.amb').forEach((b,i)=>{b.classList.toggle('on',['explain','debug','theory','algo','fc'][i]===m);});
  const isFC=m==='fc';
  document.getElementById('aow').style.display=isFC?'none':'flex';
  document.getElementById('fcw').style.display=isFC?'flex':'none';
  if(!isFC)document.getElementById('aout').innerHTML='<p class="aph" data-i18n="aiPh">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å AI ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</p>';
}
function getLastError(){
  // ‡∏î‡∏∂‡∏á Error ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Console output
  const lines=Array.from(document.querySelectorAll('#cout .ol'));
  // ‡∏´‡∏≤ index ‡∏Ç‡∏≠‡∏á Error: ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  let errStart=-1;
  for(let i=lines.length-1;i>=0;i--){
    if(lines[i].classList.contains('oe')&&/(error:|traceback)/i.test(lines[i].textContent)){
      errStart=i;break;
    }
  }
  if(errStart===-1){
    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏Ñ‡πà error lines ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ header
    const errLines=lines.filter(l=>l.classList.contains('oe'));
    if(!errLines.length)return '';
    return errLines.map(l=>l.textContent).join('\n');
  }
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏∏‡∏Å line ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà Error: ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á separator (oi) ‡∏´‡∏£‡∏∑‡∏≠ end
  const result=[];
  for(let i=errStart;i<lines.length;i++){
    if(lines[i].classList.contains('oi')&&lines[i].textContent.startsWith('‚ñ∂'))break;
    if(lines[i].classList.contains('og'))break;
    result.push(lines[i].textContent);
  }
  return result.join('\n').trim();
}

function pull(id){
  const c=getCode();
  if(!c.trim()){toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î');return;}
  document.getElementById(id).value=c;

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô debug mode ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á error ‡πÉ‡∏™‡πà d-err ‡∏î‡πâ‡∏ß‡∏¢
  if(id==='d-code'){
    const err=getLastError();
    if(err){document.getElementById('d-err').value=err;toast('‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î + Error ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!');}
    else toast('‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏û‡∏ö Error)');
    return;
  }

  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fc-code ‡πÅ‡∏•‡∏∞ e-code ‚Üí ‡∏î‡∏∂‡∏á error ‡πÉ‡∏™‡πà fc-err / ‡πÅ‡∏™‡∏î‡∏á toast ‡πÅ‡∏à‡πâ‡∏á
  if(id==='fc-code'){
    const err=getLastError();
    if(err){document.getElementById('fc-err').value=err;toast('‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î + Error ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!');}
    else toast('‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!');
    return;
  }

  toast('‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!');
}

async function claude(prompt,outEl,maxT=1500,systemMsg=null){
  if(outEl)outEl.innerHTML='<div class="ald"><span></span><span></span><span></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</div>';
  return await geminiRequest(prompt,maxT,systemMsg);
}
async function aiCall(p){
  const out=document.getElementById('aout');
  try{const t=await claude(p,out);out.innerHTML=md2html(t);}
  catch(e){out.innerHTML=`<p style="color:var(--red)">Error: ${e.message}</p>`;}
}
function doExplain(){const c=document.getElementById('e-code').value;if(!c.trim()){toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î');return;}aiCall(T().pEx(c));}
function doDebug(){const c=document.getElementById('d-code').value,e=document.getElementById('d-err').value;if(!c.trim()){toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î');return;}aiCall(T().pDbg(c,e));}
function doTheory(){const v=document.getElementById('t-in').value;if(!v.trim()){toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å');return;}aiCall(T().pTh(v));}
function doAlgo(){const v=document.getElementById('a-in').value;if(!v.trim()){toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å');return;}aiCall(T().pAl(v));}

// ‚îÄ‚îÄ‚îÄ FLOWCHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let fcS=1;
function fcZ(d){fcS=Math.max(.3,Math.min(2.5,fcS+d));document.getElementById('fcc').style.transform=`scale(${fcS})`;}
function fcFit(){fcS=1;document.getElementById('fcc').style.transform='scale(1)';}
function fcExp(){const s=document.querySelector('#fcc svg');if(!s)return;const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([s.outerHTML],{type:'image/svg+xml'}));a.download='flowchart.svg';a.click();}

async function doFC(){
  const code=document.getElementById('fc-code').value.trim();
  const err=document.getElementById('fc-err').value.trim();
  if(!code){toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î');return;}
  const cv=document.getElementById('fcc');
  cv.innerHTML='<div style="padding:20px;color:var(--dim);font-size:12px;display:flex;align-items:center;gap:8px"><div class="ald"><span></span><span></span><span></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div></div>';
  const l=lang,hasE=err.length>0;
  const numbered=code.split('\n').map((ln,i)=>`${i+1}|${ln}`).join('\n');
  const key=getApiKey();
  if(!key){cv.innerHTML='<div style="padding:14px;color:var(--red);font-size:12px">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Gemini API Key</div>';return;}

  const p=`Return a flowchart as a JSON array for this Python code.
${hasE?`Error: ${err}`:''}

Code (line number | code):
${numbered}

Output format - array of nodes:
[{"id":"n1","type":"start","label":"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô","lineStart":1,"codeSnippet":"","next":["n2"]}]

Types: start, end, process, decision, function, loop
Decision nodes: use "branches":{"Yes":"id","No":"id"} instead of "next"
Non-decision nodes: use "next":["id"] with one id
label: ${l==='th'?'‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏Ñ‡∏≥':'max 4 English words'}
lineStart: 1-based line number (integer)
codeSnippet: the actual code line, max 40 chars
isError: true for error/exception handling nodes
Keep to 12 nodes max. Every id in next/branches must exist.`;

  try{
    const sysFC='You are a flowchart generator. Always respond with valid JSON only. Wrap your array in {"nodes":[...]} object.';
    let raw=(await geminiRequest(p,2500,sysFC)).trim();

    // Parse JSON ‚Äî expect either {"nodes":[...]} or plain [...]
    let nodes;
    try{
      const obj=JSON.parse(raw);
      // handle {"nodes":[...]}, {"flowchart":[...]}, or plain array
      if(Array.isArray(obj)) nodes=obj;
      else{
        const key2=Object.keys(obj).find(k=>Array.isArray(obj[k]));
        if(key2) nodes=obj[key2];
        else throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö array ‡πÉ‡∏ô JSON object');
      }
    }catch(parseErr){
      // fallback: bracket-match extract raw array
      let depth=0,st=-1,en=-1;
      for(let i=0;i<raw.length;i++){
        const c=raw[i];
        if(c==='['&&st===-1){st=i;depth=1;}
        else if(st>-1){
          if(c==='['||c==='{')depth++;
          else if(c===']'||c==='}')depth--;
          if(c===']'&&depth===0){en=i;break;}
        }
      }
      if(st===-1||en<=st) throw new Error(`Parse failed: ${raw.slice(0,200)}`);
      nodes=JSON.parse(raw.slice(st,en+1));
    }

    if(!Array.isArray(nodes)||!nodes.length) throw new Error('Array ‡∏ß‡πà‡∏≤‡∏á');
    renderFC(nodes,hasE,code);
    document.getElementById('fct').textContent=`Flowchart ‚Äî ${act}`;
  }catch(e){
    cv.innerHTML=`<div style="padding:14px;font-size:12px"><b style="color:var(--red)">‚ö† Error:</b> ${e.message}</div>`;
  }
}
// ‚îÄ‚îÄ highlight lines in editor when clicking a flowchart node ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _fcHighlightTimeout=null;
function fcHighlightLines(lineStart,lineEnd,snippet){
  const inp=document.getElementById('code-input');
  if(!inp)return;
  const val=inp.value||'';
  const ls=Math.max(1,parseInt(lineStart)||1);
  const lines=val.split('\n');
  if(ls>lines.length)return;

  // select only lineStart (single line, trimmed of leading whitespace for clarity)
  let charStart=0;
  for(let i=0;i<ls-1;i++)charStart+=lines[i].length+1;
  const lineText=lines[ls-1]||'';
  // skip leading whitespace so selection starts at actual code
  const indent=lineText.match(/^(\s*)/)[1].length;
  const charEnd=charStart+lineText.length;
  const charStartTrimmed=charStart+indent;

  inp.focus();
  inp.setSelectionRange(charStartTrimmed,charEnd);

  // scroll so the highlighted line is near the top (with 2-line padding)
  const lh=parseFloat(getComputedStyle(inp).lineHeight)||24;
  inp.scrollTop=Math.max(0,(ls-3)*lh);
  document.getElementById('code-bg').scrollTop=inp.scrollTop;
  document.getElementById('line-nums').scrollTop=inp.scrollTop;

  // pulse highlight on cur-line overlay
  clearTimeout(_fcHighlightTimeout);
  const cl=document.getElementById('cur-line');
  if(cl){
    cl.style.background='rgba(0,212,170,.25)';
    cl.style.transition='background .1s';
    _fcHighlightTimeout=setTimeout(()=>{
      cl.style.background='';
    },2000);
  }

  // toast ‡πÅ‡∏™‡∏î‡∏á snippet + ‡πÄ‡∏•‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
  const display=snippet||lineText.trim();
  const short=display.length>44?display.slice(0,44)+'‚Ä¶':display;
  toast(`üìç ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${ls}: ${short}`,2800);
}

function renderFC(nodes,hasErr,sourceCode){
  const NW=170,NH=40,DW=180,DH=54,GY=60,PX=34;
  const map={};nodes.forEach(n=>{map[n.id]=n;});
  const vis=new Set(),q=[{id:nodes[0]?.id,col:0,row:0}];
  const pos={},cu={};
  while(q.length){
    const{id,col,row}=q.shift();if(vis.has(id)||!map[id])continue;vis.add(id);
    if(!cu[row])cu[row]=new Set();let c=col;while(cu[row].has(c))c++;cu[row].add(c);
    pos[id]={row,col:c};const n=map[id];
    if(n.branches)Object.values(n.branches).forEach((bid,i)=>q.push({id:bid,col:c+(i?2:0),row:row+1}));
    else if(n.next)n.next.forEach(nid=>q.push({id:nid,col:c,row:row+1}));
  }
  let mC=0;Object.values(pos).forEach(p=>{mC=Math.max(mC,p.col);});
  const mR=Object.values(pos).reduce((m,p)=>Math.max(m,p.row),0);
  const SW=Math.max(260,(mC+1)*(NW+PX*2)+PX),SH=(mR+2)*(NH+GY)+70;
  nodes.forEach(n=>{const p=pos[n.id]||{row:0,col:0};n._x=PX+p.col*(NW+PX*2)+NW/2;n._y=48+p.row*(NH+GY)+NH/2;});
  const fills={start:'#1a3a2a',end:'#1a2a3a',decision:'#2a1f38',loop:'#1f2a38',function:'#1a2838',error:'#3a1a1a',process:'#181c26'};
  const strks={start:'#a6e3a1',end:'#89b4fa',decision:'#cba6f7',loop:'#f9e2af',function:'#89b4fa',error:'#f38ba8',process:'#252a38'};
  const tc={start:'#a6e3a1',end:'#89b4fa',decision:'#cba6f7',loop:'#f9e2af',function:'#89b4fa',error:'#f38ba8',process:'#cdd6f4'};
  let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${SW}" height="${SH}">
<defs>
<marker id="a" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto"><polygon points="0 0,7 2.5,0 5" fill="#3a3f58"/></marker>
<marker id="ar" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto"><polygon points="0 0,7 2.5,0 5" fill="#f38ba8"/></marker>
<filter id="gl"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
</defs>
<rect width="100%" height="100%" fill="#0d0f14"/>`;
  const drawn=new Set();
  nodes.forEach(n=>{
    const de=(tid,lbl,isY)=>{
      const k=`${n.id}->${tid}`;if(drawn.has(k)||!map[tid])return;drawn.add(k);
      const t2=map[tid],isE=n.isError||t2.isError;
      const col=isE?'#f38ba8':'#3a3f58',mk=isE?'url(#ar)':'url(#a)';
      const x1=n._x,y1=n._y+(n.type==='decision'?DH:NH)/2;
      const x2=t2._x,y2=t2._y-(t2.type==='decision'?DH:NH)/2;
      const my=(y1+y2)/2;const ds=isE?'stroke-dasharray="5 3"':'';
      if(Math.abs(x1-x2)<4)svg+=`<path d="M${x1},${y1} C${x1},${my} ${x2},${my} ${x2},${y2}" fill="none" stroke="${col}" stroke-width="1.5" ${ds} marker-end="${mk}"/>`;
      else{svg+=`<path d="M${x1},${y1} L${x1},${my} L${x2},${my} L${x2},${y2}" fill="none" stroke="${col}" stroke-width="1.5" ${ds} marker-end="${mk}"/>`;if(lbl)svg+=`<text x="${(x1+x2)/2}" y="${my-4}" fill="${isY?'#a6e3a1':'#f38ba8'}" font-size="10" text-anchor="middle">${lbl}</text>`;}
    };
    if(n.branches)Object.entries(n.branches).forEach(([l,tid])=>de(tid,l,l==='Yes'||l==='True'));
    else if(n.next)n.next.forEach(tid=>de(tid,'',false));
  });
  nodes.forEach(n=>{
    const cx=n._x,cy=n._y,tp=n.type||'process',isE=n.isError;
    const cl=isE?'error':tp;
    const wt=(txt,w)=>{const ws=txt.split(' ');const ls=[];let cur='';ws.forEach(w2=>{const ts=cur?cur+' '+w2:w2;if(ts.length*6.5>w&&cur){ls.push(cur);cur=w2;}else cur=ts;});if(cur)ls.push(cur);return ls.slice(0,2);};
    const ga=isE?'filter="url(#gl)"':'';
    const hasLine=n.lineStart!=null&&parseInt(n.lineStart)>0;
    // wrap in clickable group
    svg+=`<g data-nid="${n.id}" style="cursor:${hasLine?'pointer':'default'}">`;
    if(tp==='start'||tp==='end'){
      svg+=`<rect x="${cx-NW/2}" y="${cy-NH/2}" width="${NW}" height="${NH}" rx="20" fill="${fills[tp]}" stroke="${strks[tp]}" stroke-width="2" ${ga}/>`;
      svg+=`<text x="${cx}" y="${cy}" fill="${tc[tp]}" font-size="12" font-weight="700" text-anchor="middle" dominant-baseline="middle">${n.label}</text>`;
    }else if(tp==='decision'){
      const hw=DW/2,hh=DH/2;
      svg+=`<polygon points="${cx},${cy-hh} ${cx+hw},${cy} ${cx},${cy+hh} ${cx-hw},${cy}" fill="${fills.decision}" stroke="${isE?'#f38ba8':'#cba6f7'}" stroke-width="${isE?2:1.5}" ${ga}/>`;
      const ls=wt(n.label,DW-20);const sy=cy-(ls.length-1)*8;
      ls.forEach((l,i)=>svg+=`<text x="${cx}" y="${sy+i*16}" fill="${tc.decision}" font-size="11" text-anchor="middle" dominant-baseline="middle">${l}</text>`);
    }else{
      const dash={function:'stroke-dasharray:6 2;',error:'stroke-dasharray:5 3;'}[cl]||'';
      const ic={loop:'‚Üª ',function:'∆í ',error:'‚ö† '}[tp]||'';
      svg+=`<rect x="${cx-NW/2}" y="${cy-NH/2}" width="${NW}" height="${NH}" rx="5" fill="${fills[cl]||fills.process}" stroke="${strks[cl]||strks.process}" stroke-width="${isE?2:1.5}" style="${dash}" ${ga}/>`;
      const ls=wt(n.label,NW-16);const sy=cy-(ls.length-1)*9;
      ls.forEach((l,i)=>svg+=`<text x="${cx}" y="${sy+i*18}" fill="${tc[cl]||tc.process}" font-size="11" text-anchor="middle" dominant-baseline="middle">${i===0?ic:''}${l}</text>`);
    }
    // line number badge (top-right corner of node)
    if(hasLine){
      const bx=cx+NW/2-2,by=cy-NH/2-1;
      const lbl=n.lineEnd&&n.lineEnd!==n.lineStart?`L${n.lineStart}-${n.lineEnd}`:`L${n.lineStart}`;
      const bw=lbl.length*5.5+8;
      svg+=`<rect x="${bx-bw}" y="${by}" width="${bw}" height="14" rx="3" fill="#00d4aa22" stroke="#00d4aa55" stroke-width="1"/>`;
      svg+=`<text x="${bx-bw/2}" y="${by+7}" fill="#00d4aa" font-size="8" font-family="monospace" text-anchor="middle" dominant-baseline="middle">${lbl}</text>`;
    }
    // code snippet tooltip label below node (small, mono)
    if(n.codeSnippet&&tp!=='start'&&tp!=='end'){
      const snip=n.codeSnippet.length>32?n.codeSnippet.slice(0,32)+'‚Ä¶':n.codeSnippet;
      const sy2=cy+NH/2+10;
      svg+=`<text x="${cx}" y="${sy2}" fill="#4a5568" font-size="9" font-family="monospace" text-anchor="middle">${snip.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</text>`;
    }
    if(isE&&n.errorNote){
      const bx=cx+NW/2+8,by=cy-16,bw=120,bh=38;
      svg+=`<rect x="${bx}" y="${by}" width="${bw}" height="${bh}" rx="4" fill="#2a0d0d" stroke="#f38ba8" stroke-width="1.5" stroke-dasharray="4 2"/>`;
      svg+=`<circle cx="${bx-4}" cy="${cy}" r="3" fill="#f38ba8"/>`;
      svg+=`<line x1="${bx-4}" y1="${cy}" x2="${bx}" y2="${by+bh/2}" stroke="#f38ba8" stroke-width="1" stroke-dasharray="3 2"/>`;
      svg+=`<text x="${bx+6}" y="${by+12}" fill="#f38ba8" font-size="10" font-weight="700">‚ö† Error</text>`;
      const ls=wt(n.errorNote,bw-12);ls.forEach((l,i)=>svg+=`<text x="${bx+6}" y="${by+24+i*12}" fill="#f38ba8" font-size="9">${l}</text>`);
    }
    svg+=`</g>`;
  });
  svg+='</svg>';
  document.getElementById('fcc').innerHTML=svg;
  fcS=1;document.getElementById('fcc').style.transform='scale(1)';

  // attach click handlers to clickable node groups
  document.querySelectorAll('#fcc [data-nid]').forEach(el=>{
    const nid=el.getAttribute('data-nid');
    const n=nodes.find(x=>x.id===nid);
    if(!n)return;
    el.style.cursor='pointer';
    el.addEventListener('mouseenter',()=>{
      el.querySelectorAll('rect,polygon,ellipse').forEach(s=>{s.style.filter='brightness(1.4)';s.style.transition='filter .15s';});
    });
    el.addEventListener('mouseleave',()=>{
      el.querySelectorAll('rect,polygon,ellipse').forEach(s=>{s.style.filter='';});
    });
    el.addEventListener('click',()=>{
      // highlight all nodes dimmed, this one bright
      document.querySelectorAll('#fcc [data-nid]').forEach(e2=>{
        e2.style.opacity=e2===el?'1':'0.45';e2.style.transition='opacity .2s';
      });
      setTimeout(()=>document.querySelectorAll('#fcc [data-nid]').forEach(e2=>{e2.style.opacity='1';}),1800);
      fcHighlightLines(n.lineStart,n.lineEnd,n.codeSnippet||n.label);
    });
  });
}
</script>

<div id="settings-modal">
  <div id="settings-box">
    <div class="s-title">‚öô Gemini API Settings</div>
    <div>
      <div class="s-lbl">Gemini API Key</div>
      <input class="s-inp" id="s-apikey" type="password" placeholder="AIza...">
      <div class="s-hint" style="margin-top:4px">‡∏£‡∏±‡∏ö API Key ‡∏ü‡∏£‡∏µ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></div>
    </div>
    <div>
      <div class="s-lbl">Model</div>
      <select class="s-inp" id="s-model">
        <option value="gemini-1.5-flash">gemini-1.5-flash (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥/‡∏ü‡∏£‡∏µ)</option>
        <option value="gemini-1.5-pro">gemini-1.5-pro</option>
        <option value="gemini-1.5-flash-8b">gemini-1.5-flash-8b (‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</option>
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview</option>
      </select>
    </div>
    <div class="s-row">
      <button class="s-save" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="s-save" style="background:#4a5070" onclick="testApiKey()">üîå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
      <button class="s-cancel" onclick="togSettings()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    <div id="s-test-result" style="font-size:12px;margin-top:6px;min-height:18px"></div>
  </div>
</div>

</body>
</html>
